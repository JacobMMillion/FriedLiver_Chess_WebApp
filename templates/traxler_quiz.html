{% extends "navbar.html" %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{% block title %}Quiz: Traxler Defense{% endblock %}</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0/chess.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    #board { width: 400px; margin: 20px auto; }
    #status { margin-top: 10px; font-weight: bold; }
    #feedback { margin-top: 10px; font-weight: bold; height: 1.2em; }
    #finish-btn {
      background: grey; color: white; padding: 0.5em 1em;
      border: none; border-radius: 4px; margin-top: 10px;
    }
    #finish-btn.enabled {
      background: green; cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Quiz: Traxler Defense</h1>
  <div id="board"></div>
  <div id="status">Loading…</div>
  <div id="feedback"></div>
  <button id="finish-btn" disabled>Finish Quiz</button>

  <script>
    $(function() {
      if (typeof Chessboard === 'undefined' || typeof Chess === 'undefined') {
        $('#status').text('Error loading libraries.');
        return;
      }

      var game = new Chess();

      var whiteSeq = ['e4', 'Nf3', 'Bc4', 'Ng5', 'Nxf7', 'Kxf2', 'Ke3'];
      var blackSeq = ['e5', 'Nc6', 'Nf6', 'Bc5', 'Bxf2+', 'Nxe4+', 'Qh4'];
      var whiteStep = 0, blackStep = 0;
      var wrongAttempted = Array(blackSeq.length).fill(false);

      // ← always emits a number literal, never blank
      var score = {{ score | default(0) | tojson }};
      var $feedback = $('#feedback');

      var board = Chessboard('board', {
        draggable: true,
        position: 'start',
        pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',

        onDragStart: function(src, piece) {
          return !game.game_over() &&
                 game.turn() === 'b' &&
                 piece.charAt(0) === 'b';
        },

        onDrop: function(src, tgt) {
          var mv = game.move({ from: src, to: tgt, promotion: 'q' });
          if (!mv) return 'snapback';

          var expected = blackSeq[blackStep];
          if (mv.san !== expected) {
            wrongAttempted[blackStep] = true;
            $feedback.css('color', 'red').text('Not quite.');
            game.undo();
            board.position(game.fen(), false);
            return;
          }

          var gained = !wrongAttempted[blackStep];
          if (gained) {
            score++;
            $feedback.css('color', 'green')
                     .text('Good job! +1 point (Total: ' + score + ')');
          } else {
            $feedback.css('color', 'orange')
                     .text('Correct, but no point (Total: ' + score + ')');
          }
          blackStep++;

          if (blackStep >= blackSeq.length) {
            // persist updated score on the server
            $.ajax({
              url: "{{ url_for('submit_score') }}",
              method: "POST",
              contentType: "application/json",
              data: JSON.stringify({ score: score }),
              dataType: "json"
            });

            $('#finish-btn')
              .prop('disabled', false)
              .addClass('enabled');
          }

          updateStatus();

          if (whiteStep < whiteSeq.length) {
            setTimeout(function() {
              game.move(whiteSeq[whiteStep++]);
              board.position(game.fen(), false);
              updateStatus();
            }, 800);
          }
        },

        onSnapEnd: function() {
          board.position(game.fen(), false);
        }
      });

      function updateStatus() {
        var s;
        if (game.in_checkmate()) {
          s = 'Checkmate! ' + (game.turn() === 'w' ? 'Black' : 'White') + ' wins.';
        } else if (game.in_draw()) {
          s = 'Draw.';
        } else {
          s = (game.turn() === 'w' ? 'White' : 'Black') + ' to move'
            + (game.in_check() ? ' (in check)' : '');
        }
        $('#status').text(s);
      }

      setTimeout(function() {
        game.move(whiteSeq[whiteStep]);
        whiteStep++;
        board.position(game.fen(), false);
        updateStatus();
      }, 800);

      $('#finish-btn').on('click', function() {
        window.location.href = "{{ url_for('quiz_score') }}";
      });
    });
  </script>
</body>
</html>
{% endblock %}