{% extends "navbar.html" %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{% block title %}Quiz: Fried‑Liver Trap{% endblock %}</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0/chess.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    #board { width: 400px; margin: 20px auto; }
    #status, #feedback { margin-top: 10px; font-weight: bold; }
    #feedback { height: 1.2em; }
    #continue-btn {
      background: #959595; color: white; padding: .5em 1em;
      border: none; border-radius: 4px; margin-top: 10px;
    }
    #continue-btn.enabled { background: green; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Quiz: Fried‑Liver Attack</h1>
  <div id="board"></div>
  <div id="status">Loading…</div>
  <div id="feedback"></div>

  <button id="continue-btn" disabled>Continue to Traxler Quiz</button>

  <script>
    $(function() {
      if (typeof Chessboard === 'undefined' || typeof Chess === 'undefined') {
        $('#status').text('Error loading libraries.');
        return;
      }

      var game = new Chess();
      // Load the sequences for the Fried Liver quiz
      var whiteSequence = {{ liver_whiteSeq | tojson }};
      var blackReplies = {{ liver_blackSeq | tojson }};
      var whiteStep = 0, blackStep = 0, score = 0;
      var wrongAttempted = Array(whiteSequence.length).fill(false);
      var board = Chessboard('board',{
        draggable: true,
        position: 'start',
        pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
        onDragStart: function(src,piece) {
          return !game.game_over() && game.turn()==='w' && piece[0]==='w';
        },
        onDrop: function(src, tgt) {
          var mv = game.move({from:src,to:tgt,promotion:'q'});
          if (!mv) return 'snapback';

          var expected = whiteSequence[whiteStep];
          if (mv.color==='w') {
            if (mv.san !== expected) {
              wrongAttempted[whiteStep] = true;
              $('#feedback').css('color','red').text('Not quite.');
              game.undo();
              board.position(game.fen(),false);
              return;
            }
            // correct
            if (!wrongAttempted[whiteStep]) { score++; }
            $('#feedback')
              .css('color', wrongAttempted[whiteStep]? 'orange':'green')
              .text(
                wrongAttempted[whiteStep]
                ? 'Correct, no point (Total: '+score+')'
                : 'Good job! +1 point (Total: '+score+')'
              );
            whiteStep++;

            if (whiteStep >= whiteSequence.length) {
              // 1) send to server
              $.ajax({
                url: "{{ url_for('submit_score') }}",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ score: score }),
              });
              // 2) enable buttons
              $('#continue-btn').prop('disabled',false).addClass('enabled');
              $('#learn-btn').show();
            }
          }
          updateStatus();

          // black auto‑reply
          if (game.turn()==='b' && blackStep < blackReplies.length) {
            setTimeout(function(){
              game.move(blackReplies[blackStep++]);
              board.position(game.fen(),false);
              updateStatus();
            }, 800);
          }
        },
        onSnapEnd: function(){ board.position(game.fen(),false); }
      });

      function updateStatus() {
        var s;
        if (game.in_checkmate()) {
          s = 'Checkmate! '+ (game.turn()==='w'?'Black':'White') +' wins.';
        } else if (game.in_draw()) {
          s = 'Draw.';
        } else {
          s = (game.turn()==='w'?'White':'Black')+' to move'
            + (game.in_check()? ' (in check)':'');
        }
        $('#status').text(s);
      }
      updateStatus();

      // navigation:
      $('#continue-btn').click(function(){
        window.location.href = "{{ url_for('traxler_quiz') }}";
      });
    });
  </script>
</body>
</html>
{% endblock %}
